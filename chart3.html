<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>d3-waffle</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.5/paper/bootstrap.min.css" media="screen"
    rel="stylesheet">
  <link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet"
    type="text/css">
  <style type="text/css">
    body {
      font-family: "Open Sans", sans-serif;
    }

    .container {
      width: 100%;
    }

    rect.selected {
      fill: rgb(162, 223, 112) !important;
      opacity: 1 !important;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" type="text/javascript"></script>
  <script src="d3-waffle.js" type="text/javascript"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
  <script type="text/javascript">
    const data = {
      "squares": [
        {
          "apartments": [
            {
              "id": 1,
              "name": "Stan broj 1",
              "surface": 45.44,
              "floor": 1,
              "color": "#6060e0",
              "image": "some_image.jpg",
              "link": "http://somelink.com?job_id=1",
              "value": 120000
            },
            {
              "id": 2,
              "name": "Stan broj 2",
              "surface": 52.14,
              "floor": 1,
              "color": "#DDE0BD",
              "image": "some_image.jpg",
              "link": "http://somelink.com?job_id=1",
              "value": 145000
            },
            {
              "id": 3,
              "name": "Stan broj 3",
              "surface": 85.32,
              "floor": 1,
              "color": "#D0D1AC",
              "image": "some_image.jpg",
              "link": "http://somelink.com?job_id=1",
              "value": 135000
            },
            {
              "id": 4,
              "name": "Stan broj 4",
              "surface": 105.75,
              "floor": 1,
              "color": "#B6A39E",
              "image": "some_image.jpg",
              "link": "http://somelink.com?job_id=1",
              "value": 223000
            },
            {
              "id": 5,
              "name": "Stan broj 5",
              "surface": 95.75,
              "floor": 2,
              "color": "#948B89",
              "image": "some_image.jpg",
              "link": "http://somelink.com?job_id=1",
              "value": 205000
            }
          ],
          "garage_space": [
            {
              "id": 6,
              "name": "Garažno mesto 1",
              "surface": 12.5,
              "floor": -2,
              "color": "#845EC2",
              "link": "http://somelink.com?job_id=1",
              "value": 19500
            },
            {
              "id": 7,
              "name": "Garažno mesto 2",
              "surface": 12.5,
              "floor": -2,
              "color": "#2C73D2",
              "link": "http://somelink.com?job_id=1",
              "value": 19500
            },
            {
              "id": 8,
              "name": "Garažno mesto 3",
              "surface": 12.5,
              "floor": -2,
              "color": "#0081CF",
              "link": "http://somelink.com?job_id=1",
              "value": 19500
            },
            {
              "id": 9,
              "name": "Garažno mesto 4",
              "surface": 12.5,
              "floor": -2,
              "color": "#0089BA",
              "link": "http://somelink.com?job_id=1",
              "value": 19500
            },
            {
              "id": 10,
              "name": "Garažno mesto 5",
              "surface": 12.5,
              "floor": -1,
              "color": "#008E9B",
              "link": "http://somelink.com?job_id=1",
              "value": 19500
            },
            {
              "id": 11,
              "name": "Garažno mesto 6",
              "surface": 12.5,
              "floor": -1,
              "color": "#008F7A",
              "link": "http://somelink.com?job_id=1",
              "value": 19500
            }
          ],
          "commercial_space": [
            {
              "id": 12,
              "name": "Lokal 1",
              "surface": 132.5,
              "floor": 0,
              "color": "#00817D",
              "link": "http://somelink.com?job_id=1",
              "value": 295000
            },
            {
              "id": 13,
              "name": "Lokal 2",
              "surface": 144,
              "floor": 0,
              "color": "#00737A",
              "link": "http://somelink.com?job_id=1",
              "value": 325000
            }
          ],
          "warehouse_space": [
            {
              "name": "Magacin 1",
              "floor": 0,
              "surface": 30,
              "color": "#006658",
              "value": 25000
            }
          ]
        }
      ]
    }

    function calculateTotalValues(data) {
      const result = [];
      data.squares.forEach(square => {
        for (const [key, value] of Object.entries(square)) {
          if (Array.isArray(value)) {
            const totalValue = value.reduce((sum, item) => sum += item.value, 0);
            result.push({ name: key, value: totalValue });
          }
        }
      });
      return result;
    }
    const data2 = calculateTotalValues(data);
    function init() {

      /* to color elements we use the class name ( slugigy(name) ) */
      var domain = data2.map(function (d) { return slugify(d.name); })
      var range = ["#c7d4b6", "#a3aabd", "#a0d0de", "#97b5cf"]
      var palette = d3.scale.ordinal().domain(domain).range(range);

      var chart4 = d3waffle()
        .rows(15)
        .scale(1 / 500 / 10)
        .colorscale(palette)
        .appearancetimes(function (d, i) { return i * 10 + Math.random() * 250; })
        .height(500)
        .width(300)

      d3.select("#container-4")
        .datum(data2)
        .call(chart4);
    }
    $(function () {
      init();
    });
    let selectedClassList = []
    function click(d) {
      if (selectedClassList.indexOf(d.class) == -1) {
        d3.selectAll(`.${d.class}`)
          .classed('selected', true)
        selectedClassList.push(d.class)
        $('#CountOfSelectedCells').text(calculateSelectedValuesSum(data2, selectedClassList))
      } else {
        selectedClassList = removeElementFromArray(selectedClassList, d.class)
        $('#CountOfSelectedCells').text(calculateSelectedValuesSum(data2, selectedClassList))
        d3.selectAll(`.${d.class}`)
          .classed('selected', false)
      }
    }

    function calculateSelectedValuesSum(data, selectedClasses) {
      return data.reduce((sum, item) => {
        if (selectedClasses.includes(item.class)) {
          return sum + item.value;
        }
        return sum;
      }, 0);
    }
    function resetSelected() {

      const list = document.getElementById("container-4");
      if (list.hasChildNodes()) {
        list.removeChild(list.children[0]);
      }
      init()
      $('#CountOfSelectedCells').text(0)
    }
    function removeElementFromArray(array, element) {
      return array.filter(item => item != element);
    }
  </script>
</head>

<body>

  <div class="container">

    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <div class="panel panel-danger">
          <div class="panel-body">
            <div class="container" id="container-4"></div>
          </div>
          <div>
            <span>Number of selected cells:&nbsp; </span>
            <span id="CountOfSelectedCells">0</span>
          </div>
          <button onclick="resetSelected()">reset</button>
        </div>
      </div>
    </div>
    <hr>
  </div>
</body>

</html>